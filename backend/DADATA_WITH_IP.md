# Настройка DaData API при использовании IP-адреса вместо доменного имени

Этот документ содержит дополнительные рекомендации по настройке DaData API при развертывании приложения на сервере с использованием IP-адреса (217.198.5.205) вместо доменного имени.

## 1. Получение API-ключей DaData

Для работы с DaData API необходимо получить API-ключи:

1. Зарегистрируйтесь или войдите на сайте [dadata.ru](https://dadata.ru/)
2. Перейдите в раздел [Кабинет -> API-ключи](https://dadata.ru/profile/#info)
3. Скопируйте значения "API-ключ" и "Секретный ключ"

## 2. Настройка переменных окружения

В файле `.env` укажите полученные ключи:

```
# DaData API ключи
DADATA_TOKEN=ваш_токен_dadata
DADATA_SECRET=ваш_секретный_ключ_dadata
```

## 3. Настройка CORS для IP-адреса

При использовании IP-адреса важно правильно настроить CORS. В файле `.env` укажите:

```
# Настройки CORS для IP-адреса
CORS_ORIGINS=http://217.198.5.205
```

В файле `app/main.py` проверьте наличие правильной настройки CORS:

```python
from fastapi.middleware.cors import CORSMiddleware

# Получение значения из переменной окружения
cors_origins = os.getenv("CORS_ORIGINS", "http://217.198.5.205").split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## 4. Настройка фронтенда для работы с DaData API по IP-адресу

В файле `.env.production` во фронтенд-директории укажите:

```
VITE_API_BASE_URL=http://217.198.5.205/api
VITE_DADATA_TOKEN=ваш_публичный_токен_dadata
```

> **Примечание**: Публичный токен DaData (VITE_DADATA_TOKEN) - это тот же API-ключ, который вы получили в личном кабинете. Не указывайте в переменных окружения фронтенда секретный ключ - он должен использоваться только на бэкенде.

## 5. Ограничения по IP-адресу в DaData

В личном кабинете DaData вы можете настроить ограничения по IP:

1. Перейдите в [Кабинет -> Настройки -> Безопасность](https://dadata.ru/profile/#security)
2. В разделе "Ограничения по IP" добавьте IP-адрес вашего сервера (217.198.5.205)

Это ограничит доступ к API только с указанного IP-адреса, что повысит безопасность.

## 6. Проверка работы DaData API

После настройки проверьте работу DaData API, выполнив тестовый запрос:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -H "Authorization: Token ваш_токен_dadata" \
  -d '{"query": "7707083893"}' \
  https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/party
```

Или через API вашего приложения:

```bash
curl -X GET "http://217.198.5.205/api/dadata/company?inn=7707083893"
```

## 7. Дополнительные рекомендации

1. **Безопасность**: При использовании IP-адреса без SSL, учтите, что данные (включая DaData API токены) передаются в незашифрованном виде. По возможности настройте самоподписанный SSL-сертификат или используйте VPN для доступа к серверу.

2. **Лимиты API**: Следите за использованием API DaData, особенно на тарифах с ограниченным количеством запросов. В личном кабинете DaData вы можете отслеживать статистику использования.

3. **Миграция на домен**: Когда вы решите перейти с IP-адреса на доменное имя, не забудьте обновить настройки CORS и переменные окружения.

## 8. Устранение неполадок

Если DaData API не работает:

1. Проверьте правильность указанных API-ключей
2. Убедитесь, что CORS настроен правильно
3. Проверьте, не истекла ли подписка на DaData
4. Проверьте лимиты запросов в личном кабинете DaData

Для более подробной информации обратитесь к официальной документации DaData API: [https://dadata.ru/api/](https://dadata.ru/api/)